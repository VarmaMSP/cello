- name: add rabbitmq signing key
  apt_key:
    url: https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
    state: present

# https://www.rabbitmq.com/install-debian.html#apt-pinning
- name: copy erlang preference file
  copy:
    src: files/preferences
    dest: /etc/apt/preferences.d/erlang

- name: add erlang and rabbitmq repositories
  apt_repository:
    repo: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang-22.x
    - deb https://dl.bintray.com/rabbitmq/debian bionic main

- name: install erlang and rabbitmq
  apt:
    pkg: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - erlang-base
    - erlang-asn1
    - erlang-crypto
    - erlang-eldap
    - erlang-ftp
    - erlang-inets
    - erlang-mnesia
    - erlang-os-mon
    - erlang-parsetools
    - erlang-public-key
    - erlang-runtime-tools
    - erlang-snmp
    - erlang-ssl
    - erlang-syntax-tools
    - erlang-tftp
    - erlang-tools
    - erlang-xmerl
    - rabbitmq-server
  notify:
    - enable rabbitmq-server service

# https://www.rabbitmq.com/plugins.html#enabled-plugins-file
- name: copy enabled_plugins file
  copy:
    src: files/enabled_plugins
    dest: /etc/rabbitmq/enabled_plugins
  notify:
    - restart rabbitmq-server

# https://www.rabbitmq.com/configure.html
- name: copy rabbitmq configuration
  template:
    src: rabbitmq.conf.j2
    dest: /etc/rabbitmq/rabbitmq.conf
  notify:
    - restart rabbitmq-server

- meta: flush_handlers

- name: ensure rabbitmq server is started
  service:
    name: rabbitmq-server
    state: started
    enabled: yes
